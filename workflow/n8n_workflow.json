{
  "name": "My workflow 2",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "89b9d36e-7164-4e2a-895c-9154b7c1345d",
              "name": "type",
              "value": "êµ­ë‚´",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -528,
        1872
      ],
      "id": "0672a55c-690e-495b-90b4-6d3b91337c66",
      "name": "êµ­ë‚´ ë¼ë²¨ë§"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9b9d36e-7164-4e2a-895c-9154b7c1345d",
              "name": "type",
              "value": "í•´ì™¸",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -528,
        2048
      ],
      "id": "d2d3b000-bd97-43a4-8010-776326314481",
      "name": "í•´ì™¸ ë¼ë²¨ë§"
    },
    {
      "parameters": {
        "fileSelector": "/files/incoming/n8ndata.csv",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1.1,
      "position": [
        -1280,
        1056
      ],
      "id": "0de80d5b-4bea-4e31-bff8-a176241c1424",
      "name": "Read/Write Files from Disk"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -1088,
        1056
      ],
      "id": "47a3793f-53ff-43c7-b9e6-ecb4f4507eb6",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "table": {
          "__rl": true,
          "value": "ingest_runs",
          "mode": "list",
          "cachedResultName": "ingest_runs"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -1280,
        1248
      ],
      "id": "1d0dea38-9636-4da3-b017-f903bffc9205",
      "name": "Insert rows in a table",
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "transactions_stage",
          "mode": "list",
          "cachedResultName": "transactions_stage"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -304,
        1056
      ],
      "id": "c0e5b7a5-ad39-40ef-a227-8e379641e5ad",
      "name": "Select rows from a table",
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const j = item.json;\n\n  // í‚¤ ì¬ë£Œ(ë¬¸ìì—´) - êµ¬ë¶„ì í¬í•¨í•´ì„œ í•©ì¹˜ê¸°\n  // ì·¨ì†Œê¹Œì§€ í¬í•¨í•˜ë ¤ë©´ orig_* ê°™ì€ ì°¸ì¡°í‚¤ê°€ ìˆìœ¼ë©´ ê°™ì´ ë„£ì–´ë„ ë¨\n  const material = [\n    j.source_system,\n    j.batch_file_id,\n    j.merchant_id,\n    j.approval_no,\n    j.txn_datetime,\n    j.amount,\n    j.card_token,          // ìˆë‹¤ë©´(í† í°/ë§ˆìŠ¤í‚¹)\n    j.channel,\n    j.is_cancel\n  ].map(v => v ?? '').join('|');\n\n  j.txn_key_material = material;\n\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -896,
        1056
      ],
      "id": "41542ede-ffac-4819-81df-4cb715bf7931",
      "name": "í•´ì‹œë¥¼ìœ„í•œ ì‘ì—…"
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": {
          "__rl": true,
          "value": "transactions",
          "mode": "list",
          "cachedResultName": "transactions"
        },
        "dataMode": "defineBelow",
        "columnToMatchOn": "txn_key",
        "valueToMatchOn": "={{$json.txn_key}}",
        "valuesToSend": {
          "values": [
            {
              "column": "customer_key",
              "value": "={{$json.customer_key}}"
            },
            {
              "column": "txn_datetime",
              "value": "={{$json.txn_datetime}}"
            },
            {
              "column": "approval_no",
              "value": "={{$json.approval_no}}"
            },
            {
              "column": "merchant_name",
              "value": "={{$json.merchant_name}}"
            },
            {
              "column": "amount",
              "value": "={{$json.amount}}"
            },
            {
              "column": "currency",
              "value": "={{$json.currency}}"
            },
            {
              "column": "is_cancel",
              "value": "={{String($json.is_cancel)==='true' ? 1:0}}"
            },
            {
              "column": "original_approval_no",
              "value": "={{$json.original_approval_no}}"
            },
            {
              "column": "channel",
              "value": "={{$json.channel}}"
            },
            {
              "column": "city",
              "value": "={{$json.city}}"
            },
            {
              "column": "mcc",
              "value": "={{$json.mcc}}"
            },
            {
              "column": "merchant_id",
              "value": "={{$json.merchant_id}}"
            },
            {
              "column": "category",
              "value": "={{$json.category}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        128,
        1264
      ],
      "id": "c9555045-760d-4123-ba86-1cb9d36db20b",
      "name": "1ì°¨ ê²€ì¦ë³¸",
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function s(v) { return (v === null || v === undefined) ? '' : String(v).trim(); }\nfunction toInt(v, def=null) {\n  const t = s(v).replace(/,/g,''); if (!t) return def;\n  const n = Number(t); return Number.isFinite(n) ? Math.trunc(n) : def;\n}\nfunction toBool(v) {\n  const t = s(v).toLowerCase();\n  if (['true','1','y','yes'].includes(t)) return true;\n  if (['false','0','n','no'].includes(t)) return false;\n  return null;\n}\n\nreturn items\n  .map(item => {\n    const row = item.json;\n\n    // ê³µë°± ì¤„ ì œê±°\n    const keys = Object.keys(row || {});\n    if (keys.length === 0 || keys.every(k => s(row[k]) === '')) return null;\n\n    const cleaned = {\n      batch_file_id: s(row.batch_file_id),\n      batch_date: s(row.batch_date),\n      source_system: s(row.source_system),\n      customer_key: s(row.customer_key),\n      card_token: s(row.card_token) || null,\n      txn_datetime: s(row.txn_datetime),\n      approval_no: s(row.approval_no),\n      merchant_name: s(row.merchant_name),\n      merchant_id: s(row.merchant_id),\n      mcc: s(row.mcc) || null,\n      category: s(row.category) || null,\n      amount: toInt(row.amount, null),\n      currency: s(row.currency) || 'KRW',\n      is_cancel: toBool(row.is_cancel),\n      original_approval_no: s(row.original_approval_no) || null,\n      installment_months: toInt(row.installment_months, null),\n      channel: s(row.channel),\n      city: s(row.city) || null,\n      txn_key: row.txn_key || null,\n    };\n\n    cleaned.txn_key_material = [\n      cleaned.customer_key,\n      cleaned.approval_no,\n      cleaned.txn_datetime,\n      String(cleaned.amount ?? ''),\n      String(cleaned.is_cancel),\n    ].join('|');\n\n    return { json: cleaned };\n  })\n  .filter(Boolean);\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -112,
        1056
      ],
      "id": "dbe51408-bd8e-4cc8-ac85-fa2e12dadfe0",
      "name": "ì •ì œí™”"
    },
    {
      "parameters": {
        "table": {
          "__rl": true,
          "value": "transactions_stage",
          "mode": "list",
          "cachedResultName": "transactions_stage"
        },
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "run_id",
              "value": "={{$items(\"Code in JavaScript1\")[0].json[\"run_id\"]}}"
            },
            {
              "column": "txn_key",
              "value": "={{$json.txn_key}}"
            },
            {
              "column": "batch_file_id",
              "value": "={{$json.batch_file_id}}"
            },
            {
              "column": "batch_date",
              "value": "={{$json.batch_date}}"
            },
            {
              "column": "source_system",
              "value": "={{$json.source_system}}"
            },
            {
              "column": "customer_key",
              "value": "={{$json.customer_key}}"
            },
            {
              "column": "txn_datetime",
              "value": "={{$json.txn_datetime}}"
            },
            {
              "column": "approval_no",
              "value": "={{$json.approval_no}}"
            },
            {
              "column": "merchant_name",
              "value": "={{$json.merchant_name}}"
            },
            {
              "column": "merchant_id",
              "value": "={{$json.merchant_id}}"
            },
            {
              "column": "amount",
              "value": "={{$json.amount}}"
            },
            {
              "column": "currency",
              "value": "={{$json.currency}}"
            },
            {
              "column": "is_cancel",
              "value": "={{String($json.is_cancel)==='true' ? 1:0}}"
            },
            {
              "column": "installment_months",
              "value": "={{$json.installment_months}}"
            },
            {
              "column": "channel",
              "value": "={{$json.channel}}"
            },
            {
              "column": "city",
              "value": "={{$json.city}}"
            },
            {
              "column": "mcc",
              "value": "={{$json.mcc}}"
            },
            {
              "column": "category",
              "value": "={{$json.category}}"
            },
            {
              "column": "original_approval_no",
              "value": "={{$json.original_approval_no}}"
            },
            {
              "column": "card_token",
              "value": "={{$json.card_token}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -512,
        1056
      ],
      "id": "3d216c0a-0803-4b54-992d-b718ea31c3bb",
      "name": "ì›ë³¸ ì ì¬",
      "alwaysOutputData": true,
      "executeOnce": false,
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    recon_id, \n    auth_amount, \n    currency, \n    customer_key, \n    channel, \n    category,\n    city,\n    created_at \nFROM settlement_transactions\nWHERE recon_run_id = '{{$node[\"Code (Recon Meta)\"].json.recon_run_id}}'\n  AND recon_date   = '{{$node[\"Code (Recon Meta)\"].json.recon_date}}';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -992,
        1904
      ],
      "id": "520c7616-d884-4f3c-bc96-0e39fb159e60",
      "name": "select_settlement_transactions",
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "52dd7483-6703-446e-82b4-fee91ae66dec",
              "leftValue": "={{ $json.currency }}",
              "rightValue": "KRW",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -752,
        1904
      ],
      "id": "5aee99ac-73e4-40d8-82a2-9ddc864d40fc",
      "name": "êµ­ë‚´ê²°ì œ/í•´ì™¸ê²°ì œ ë¶„ê¸°"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=http://elasticsearch:9200/settlement-korea/_doc/{{ $('êµ­ë‚´ê²°ì œ/í•´ì™¸ê²°ì œ ë¶„ê¸°').item.json.recon_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "elasticsearchApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recon_id\": {{ $json.recon_id }},\n  \"type\": \"{{ $json.type }}\",\n  \"@timestamp\": \"{{ $json.created_at }}\", \n  \n  \"payment\": {\n    \"currency\": \"{{ $json.currency }}\",\n    \"amount\": {{ $json.auth_amount }},\n    \"merchant\": \"{{ $json.merchant_id }}\",\n    \"channel\": \"{{ $json.channel }}\"\n  },\n\n  \"customer\": {\n    \"id\": \"{{ $json.customer_key }}\"\n  },\n\n  \"analysis\": {\n  \"category\": \"{{ $json.category }}\",\n  \"city\": \"{{ $json.city }}\"\n}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -336,
        1872
      ],
      "id": "8a7c641a-b344-4962-9c44-7256fd9a9631",
      "name": "ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì ì¬(êµ­ë‚´)",
      "credentials": {
        "elasticsearchApi": {
          "id": "ZqtirwX5Peetu8lS",
          "name": "Elasticsearch account 3"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=http://elasticsearch:9200/settlement-overseas/_doc/{{ $('êµ­ë‚´ê²°ì œ/í•´ì™¸ê²°ì œ ë¶„ê¸°').item.json.recon_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "elasticsearchApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recon_id\": {{ $json.recon_id }},\n  \"type\": \"{{ $json.type }}\",\n  \"@timestamp\": \"{{ $json.created_at }}\", \n  \n  \"payment\": {\n    \"currency\": \"{{ $json.currency }}\",\n    \"amount\": {{ $json.auth_amount }},\n    \"merchant\": \"{{ $json.merchant_id }}\",\n    \"channel\": \"{{ $json.channel }}\"\n  },\n\n  \"customer\": {\n    \"id\": \"{{ $json.customer_key }}\"\n  },\n\n  \"analysis\": {\n    \"category\": \"{{ $json.category }}\", \n    \"city\": \"{{ $json.city }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -336,
        2048
      ],
      "id": "c667a7f3-1376-4c3f-ad17-7a097f8658eb",
      "name": "ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì ì¬(í•´ì™¸)",
      "credentials": {
        "elasticsearchApi": {
          "id": "ZqtirwX5Peetu8lS",
          "name": "Elasticsearch account 3"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "409e5e33-56a8-4ccb-9d22-7bb04ade0224",
              "name": "recon_id",
              "value": "{{ $('êµ­ë‚´ ë¼ë²¨ë§').item.json.recon_id }",
              "type": "string"
            },
            {
              "id": "373d72cf-a2a4-427d-80ad-f09b6a3fc01b",
              "name": "auth_amount",
              "value": "={{ $('êµ­ë‚´ ë¼ë²¨ë§').item.json.auth_amount }}",
              "type": "number"
            },
            {
              "id": "1243d372-4ca3-4141-ba81-e54aae70ba5a",
              "name": "type",
              "value": "êµ­ë‚´",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -144,
        1872
      ],
      "id": "36facae0-aa47-434e-a07c-2f454b6a5f0a",
      "name": "ë°ì´í„° ë³µì› (êµ­ë‚´)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7189eef1-500e-4611-b00c-f5cf71a6f09f",
              "name": "recon_id",
              "value": "{{ $('í•´ì™¸ ë¼ë²¨ë§').item.json.recon_id }",
              "type": "string"
            },
            {
              "id": "6359971c-7c5f-49d5-a262-b9afa1ffa9cc",
              "name": "auth_amount",
              "value": "={{ $('í•´ì™¸ ë¼ë²¨ë§').item.json.auth_amount }}",
              "type": "number"
            },
            {
              "id": "fd874cf3-6e68-49d2-b2d2-f2f75dd34e50",
              "name": "type",
              "value": "í•´ì™¸",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -144,
        2048
      ],
      "id": "511d180d-9fec-4bc7-89df-d394127bb05b",
      "name": "ë°ì´í„° ë³µì› (í•´ì™¸)"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        80,
        1968
      ],
      "id": "982a956a-a335-4eeb-b370-a653f6d46afd",
      "name": "ë°ì´í„° ë³‘í•©"
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {
              "field": "recon_id"
            },
            {
              "aggregation": "sum",
              "field": "auth_amount"
            }
          ]
        },
        "fieldsToSplitBy": "type",
        "options": {}
      },
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1,
      "position": [
        256,
        1968
      ],
      "id": "2810babe-49aa-4216-bc19-5192fa8fe0a9",
      "name": "ìœ í˜•ë³„ í•©ê³„ ì‚°ì¶œ"
    },
    {
      "parameters": {
        "jsCode": "// Summarize1 ë…¸ë“œì˜ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.\nconst items = $input.all();\n\n// ì•ˆì „í•˜ê²Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜\nconst getData = (targetType) => {\n  const item = items.find(i => i.json.type === targetType);\n  if (!item) return { count: 0, amount: 0 };\n  \n  const json = item.json;\n  \n  // 1. ê±´ìˆ˜ ì°¾ê¸°\n  const count = json.count || json.count_recon_id || 0;\n  \n  // 2. ê¸ˆì•¡ ì°¾ê¸° (ë¬¸ìë¥¼ ìˆ«ìë¡œ ë³€í™˜)\n  const rawAmount = json.total_amount || json.sum_auth_amount || 0;\n  const amount = Number(rawAmount); \n  \n  return { count, amount };\n};\n\n// êµ­ë‚´, í•´ì™¸ ë°ì´í„° ì¶”ì¶œ\nconst kr = getData(\"êµ­ë‚´\");\nconst os = getData(\"í•´ì™¸\");\n\n// 2. ì´í•©ê³„ ê³„ì‚°\nconst grandTotalCount = kr.count + os.count;\n\n// âš ï¸ ì£¼ì˜: ì›í™”(KRW)ì™€ ë‹¬ëŸ¬(USD)ëŠ” í™˜ìœ¨ ì—†ì´ ë‹¨ìˆœíˆ ë”í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.\n// ë”°ë¼ì„œ ì´ì•¡ì€ í•©ì‚°í•˜ì§€ ì•Šê³  \"10,000 KRW / $100\" í˜•íƒœë¡œ ë‚˜ë€íˆ ë³´ì—¬ì¤ë‹ˆë‹¤.\nconst totalAmountString = `${kr.amount.toLocaleString()} KRW  /  $${os.amount.toLocaleString()}`;\n\n\n// 3. ê²°ê³¼ ì¶œë ¥ (Discord ë…¸ë“œì—ì„œ ì“¸ ë³€ìˆ˜ëª…)\nreturn {\n  // êµ­ë‚´\n  kr_count: kr.count,\n  kr_sum: kr.amount.toLocaleString(),\n  \n  // í•´ì™¸ (ë‹¬ëŸ¬ í‘œì‹œ ì¶”ê°€)\n  os_count: os.count,\n  os_sum: '$' + os.amount.toLocaleString(), \n  \n  // ì „ì²´ ì´í•© (ë¬¸ìì—´ë¡œ ë°˜í™˜)\n  total_count: grandTotalCount,\n  total_amount: totalAmountString\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        1968
      ],
      "id": "b33c7157-0da5-4905-953d-bbf39e93cef4",
      "name": "ë¦¬í¬íŠ¸ ì–‘ì‹ ìƒì„±"
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "1462809324094230590",
          "mode": "id"
        },
        "channelId": {
          "__rl": true,
          "value": "1462809324819714151",
          "mode": "id"
        },
        "content": "=ğŸš€ **ê²°ì œ ë°ì´í„° ì ì¬ ë¦¬í¬íŠ¸**\n\nğŸ‡°ğŸ‡· **êµ­ë‚´ ê²°ì œ**\n- ê±´ìˆ˜: {{ $json.kr_count }}ê±´\n- ê¸ˆì•¡: {{ $json.kr_sum }} KRW\n\nğŸŒ **í•´ì™¸ ê²°ì œ**\n- ê±´ìˆ˜: {{ $json.os_count }}ê±´\n- ê¸ˆì•¡: {{ $json.os_sum }} \n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ… **ì „ì²´ ì´í•©ê³„**\n- ì´ ê±´ìˆ˜: {{ $json.total_count }}ê±´\n- ì´ ê¸ˆì•¡: {{ $json.total_amount }}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        608,
        1968
      ],
      "id": "c0184704-3642-4026-860a-872577dd71f0",
      "name": "ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ë°œì†¡",
      "webhookId": "ad491874-b9dd-484d-8260-e6b2beb39a92",
      "credentials": {
        "discordBotApi": {
          "id": "SUi5JKsQ4119EUBQ",
          "name": "Discord Bot account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE ingest_runs\nSET status = 'DONE',\n    ended_at = NOW(),\n    row_total = {{ $items(\"Crypto\").length }},\n    row_ok = {{ $items(\"Crypto\").length }},\n    row_fail = 0\nWHERE run_id = {{ $node[\"Code in JavaScript1\"].json[\"run_id\"] }};",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -992,
        1680
      ],
      "id": "2509c7d8-8c99-44c0-a2b6-58ef29a0b915",
      "name": "DBì— ë¡œê·¸ê¸°ë¡ ì ì¬",
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const recon_run_id = String($execution.id);\nconst recon_date = new Date(Date.now() - 24*60*60*1000).toISOString().slice(0,10); // ì–´ì œ YYYY-MM-DD\nconst tolerance_min = 5;\n\nreturn [{ json: { recon_run_id, recon_date, tolerance_min } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1712,
        1904
      ],
      "id": "930f7bb0-dd1b-4e2b-836b-79ea74718b05",
      "name": "Code (Recon Meta)"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1712,
        1184
      ],
      "id": "ce9d8f4e-a76f-4586-b94c-758ed2a6f2e1",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "jsCode": "// í•œ ë²ˆ ì‹¤í–‰(run)ë§ˆë‹¤ ê³ ìœ ê°’ ìƒì„±\nconst run_id = Date.now();   // ë°€ë¦¬ì´ˆ íƒ€ì„ìŠ¤íƒ¬í”„(ì¶©ë¶„íˆ ìœ ë‹ˆí¬)\nconst file_name = 'n8ndata.csv'; // ì§€ê¸ˆì€ 1ê°œ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë“œì½”ë”©(ë‚˜ì¤‘ì— ìë™í™” ê°€ëŠ¥)\n\nreturn [{\n  json: {\n    run_id,\n    file_name,\n    status: 'STARTED'\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1520,
        1184
      ],
      "id": "aeb09ce1-a344-410a-8c68-f6f3e9fbde8d",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "type": "SHA256",
        "value": "={{$json.txn_key_material}}",
        "dataPropertyName": "txn_key"
      },
      "type": "n8n-nodes-base.crypto",
      "typeVersion": 1,
      "position": [
        -704,
        1056
      ],
      "id": "41444b63-a2a7-4461-a2d7-3361afe556eb",
      "name": "Crypto"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO recon_results (\n  recon_run_id, recon_date,\n  txn_key, match_status,\n  auth_id, clearing_id,\n  auth_amount, clearing_amount,\n  merchant_id, currency,\n  channel, city,\n  auth_is_cancel, clearing_is_cancel,\n  mcc, category,\n  customer_key\n)\n\nSELECT\n  '{{$node[\"Code (Recon Meta)\"].json.recon_run_id}}' AS recon_run_id,\n  '{{$node[\"Code (Recon Meta)\"].json.recon_date}}'   AS recon_date,\n\n  c.txn_key AS txn_key,\n\n  CASE\n    WHEN IFNULL(c.is_cancel,0) = 1 THEN 'CANCEL'\n    WHEN a.approval_no IS NULL THEN 'MISSING'\n    WHEN a.merchant_id <> c.merchant_id THEN 'MERCHANT_MISMATCH'\n    WHEN a.amount <> c.amount OR a.currency <> c.currency THEN 'AMOUNT_MISMATCH'\n    WHEN ABS(TIMESTAMPDIFF(MINUTE, a.auth_datetime, c.txn_datetime))\n         > {{$node[\"Code (Recon Meta)\"].json.tolerance_min}}\n      THEN 'DATETIME_SHIFT'\n    ELSE 'MATCH'\n  END AS match_status,\n\n  a.approval_no AS auth_id,\n  c.approval_no AS clearing_id,\n\n  a.amount AS auth_amount,\n  c.amount AS clearing_amount,\n\n  c.merchant_id,\n  c.currency,\n\n  c.channel,\n  c.city,\n\n  IFNULL(a.is_cancel,0) AS auth_is_cancel,\n  IFNULL(c.is_cancel,0) AS clearing_is_cancel,\n\n  c.mcc,\n  c.category,\n\n  c.customer_key AS customer_key\n\nFROM\n(\n  SELECT\n    t.*,\n    CASE\n      WHEN IFNULL(t.is_cancel,0) = 1 THEN t.original_approval_no\n      ELSE t.approval_no\n    END AS match_approval_no\n  FROM transactions t\n  LEFT JOIN (\n    SELECT original_approval_no AS orig_approval_no\n    FROM transactions\n    WHERE IFNULL(is_cancel,0) = 1\n      AND original_approval_no IS NOT NULL\n    GROUP BY original_approval_no\n  ) cm\n    ON cm.orig_approval_no = t.approval_no\n  WHERE NOT (IFNULL(t.is_cancel,0) = 0 AND cm.orig_approval_no IS NOT NULL)\n) c\nLEFT JOIN auth_transactions a\n  ON a.approval_no = c.match_approval_no\n\nUNION ALL\n\nSELECT\n  '{{$node[\"Code (Recon Meta)\"].json.recon_run_id}}' AS recon_run_id,\n  '{{$node[\"Code (Recon Meta)\"].json.recon_date}}'   AS recon_date,\n\n  a.txn_key AS txn_key,\n  'MISSING' AS match_status,\n\n  a.approval_no AS auth_id,\n  NULL AS clearing_id,\n\n  a.amount AS auth_amount,\n  NULL AS clearing_amount,\n\n  a.merchant_id,\n  a.currency,\n\n  a.channel,\n  a.city,\n\n  IFNULL(a.is_cancel,0) AS auth_is_cancel,\n  NULL AS clearing_is_cancel,\n\n  a.mcc,\n  a.category,\n\n  a.customer_key AS customer_key\n\nFROM auth_transactions a\nLEFT JOIN\n(\n  SELECT\n    t.*,\n    CASE\n      WHEN IFNULL(t.is_cancel,0) = 1 THEN t.original_approval_no\n      ELSE t.approval_no\n    END AS match_approval_no\n  FROM transactions t\n  LEFT JOIN (\n    SELECT original_approval_no AS orig_approval_no\n    FROM transactions\n    WHERE IFNULL(is_cancel,0) = 1\n      AND original_approval_no IS NOT NULL\n    GROUP BY original_approval_no\n  ) cm\n    ON cm.orig_approval_no = t.approval_no\n  WHERE NOT (IFNULL(t.is_cancel,0) = 0 AND cm.orig_approval_no IS NOT NULL)\n) c\n  ON c.match_approval_no = a.approval_no\nWHERE c.match_approval_no IS NULL;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -1536,
        1904
      ],
      "id": "18e78ff5-b10b-4ba3-94c8-91ae55cd17cd",
      "name": "ë¹„êµí•´ì„œ recon_resultsì— ì ì¬ recon_results",
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO settlement_transactions (\n  recon_run_id, recon_date,\n  txn_key, match_status,\n  auth_id, clearing_id,\n  auth_amount, clearing_amount,\n  merchant_id, currency,\n  auth_is_cancel, clearing_is_cancel,\n  mcc, category,\n  customer_key,\n  channel, city\n)\nSELECT\n  r.recon_run_id,\n  r.recon_date,\n\n  r.txn_key,\n  r.match_status,  \n\n  r.auth_id,\n  r.clearing_id,\n\n  r.auth_amount,\n  r.clearing_amount,\n\n  r.merchant_id,\n  r.currency,\n\n  r.auth_is_cancel,\n  r.clearing_is_cancel,\n\n  r.mcc,\n  r.category,\n\n  r.customer_key,\n  r.channel,\n  r.city\nFROM recon_results r\nWHERE r.recon_run_id = '{{$node[\"Code (Recon Meta)\"].json.recon_run_id}}'\n  AND r.recon_date   = '{{$node[\"Code (Recon Meta)\"].json.recon_date}}'\n  AND r.match_status = 'MATCH';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -1232,
        1904
      ],
      "id": "8c00b202-fd1d-40f2-b6b8-fdd0337b279d",
      "name": "MATCHë§Œ ìˆëŠ” í…Œì´ë¸” settlement_transactions",
      "credentials": {
        "mySql": {
          "id": "y3ZoJLRXD1J2K46g",
          "name": "MySQL account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "êµ­ë‚´ ë¼ë²¨ë§": {
      "main": [
        [
          {
            "node": "ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì ì¬(êµ­ë‚´)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í•´ì™¸ ë¼ë²¨ë§": {
      "main": [
        [
          {
            "node": "ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì ì¬(í•´ì™¸)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read/Write Files from Disk": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "í•´ì‹œë¥¼ìœ„í•œ ì‘ì—…",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "ì •ì œí™”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í•´ì‹œë¥¼ìœ„í•œ ì‘ì—…": {
      "main": [
        [
          {
            "node": "Crypto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1ì°¨ ê²€ì¦ë³¸": {
      "main": [
        [
          {
            "node": "Code (Recon Meta)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì •ì œí™”": {
      "main": [
        [
          {
            "node": "1ì°¨ ê²€ì¦ë³¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì›ë³¸ ì ì¬": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "select_settlement_transactions": {
      "main": [
        [
          {
            "node": "êµ­ë‚´ê²°ì œ/í•´ì™¸ê²°ì œ ë¶„ê¸°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "êµ­ë‚´ê²°ì œ/í•´ì™¸ê²°ì œ ë¶„ê¸°": {
      "main": [
        [
          {
            "node": "êµ­ë‚´ ë¼ë²¨ë§",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "í•´ì™¸ ë¼ë²¨ë§",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì ì¬(êµ­ë‚´)": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ë³µì› (êµ­ë‚´)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì ì¬(í•´ì™¸)": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ë³µì› (í•´ì™¸)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë°ì´í„° ë³µì› (êµ­ë‚´)": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ë³‘í•©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë°ì´í„° ë³µì› (í•´ì™¸)": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ë³‘í•©",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ë°ì´í„° ë³‘í•©": {
      "main": [
        [
          {
            "node": "ìœ í˜•ë³„ í•©ê³„ ì‚°ì¶œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìœ í˜•ë³„ í•©ê³„ ì‚°ì¶œ": {
      "main": [
        [
          {
            "node": "ë¦¬í¬íŠ¸ ì–‘ì‹ ìƒì„±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë¦¬í¬íŠ¸ ì–‘ì‹ ìƒì„±": {
      "main": [
        [
          {
            "node": "ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ë°œì†¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ë°œì†¡": {
      "main": [
        []
      ]
    },
    "Code (Recon Meta)": {
      "main": [
        [
          {
            "node": "ë¹„êµí•´ì„œ recon_resultsì— ì ì¬ recon_results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          },
          {
            "node": "Read/Write Files from Disk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crypto": {
      "main": [
        [
          {
            "node": "ì›ë³¸ ì ì¬",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë¹„êµí•´ì„œ recon_resultsì— ì ì¬ recon_results": {
      "main": [
        [
          {
            "node": "MATCHë§Œ ìˆëŠ” í…Œì´ë¸” settlement_transactions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MATCHë§Œ ìˆëŠ” í…Œì´ë¸” settlement_transactions": {
      "main": [
        [
          {
            "node": "select_settlement_transactions",
            "type": "main",
            "index": 0
          },
          {
            "node": "DBì— ë¡œê·¸ê¸°ë¡ ì ì¬",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "3970183c-af17-4d3e-9085-9f2d0208c5c8",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "3019ebb37314f43367674b0a25625e77c51cd68bfadec5cf292c93441d481346"
  },
  "id": "Zs9tNVWW2m6dAWsEZovgO",
  "tags": []
}